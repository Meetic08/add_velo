############################# PROJET ADD analyse -- Léo GABET ###################################

############################### Charger les différentes librairies ######################################

library(installr)
library(lmtest)
library(tidyverse)
library(data.table)
library(magrittr)
library(DAAG)
library(plotly)
library(tseries)
library(olsrr) 
library(car)
library(readr)
library(readxl)
library(dplyr)
library(FactoMineR)
library(factoextra)
library(openxlsx)
library(Factoshiny)
library(gridExtra)


############# On importe les données #################

######################### PISTE CYCLABLE VELO PARIS ########################################
data_piste_paris <- read.table("C:/Users/33662/Desktop/add_velo/data/data_cycle-piste.csv", sep=",", header = TRUE)
view(data_piste_paris)

######################### ACCIDENTS VELO FRANCE #################################
data <- read.csv("C:/Users/33662/Desktop/add_velo/data/data_clean.csv", sep=",", header = TRUE)

data <- data %>%
  mutate(dep = as.numeric(dep))
data <- data %>%
  mutate(long = as.numeric(long))


ggplot(data, aes(x = Region)) +
  geom_bar(stat = "count", fill = "skyblue", color = "black") +
  coord_flip() +  # Cela inverse les axes, rendant le graphique horizontal
  labs(title = "Accidents en France en fonction des régions") +
  xlab("Régions") + 
  ylab("Nb accidents") +
  theme_minimal()


table(data$Region)





View(data)

######################### ARRONDISSEMENT AVEC ACC VELO PARIS ########################################
data_arr_paris <- read.table("C:/Users/33662/Desktop/add_velo/data/data_paris_arron-acc.csv", sep=",", header = TRUE)
view(data_arr_paris)
summary(data_arr_paris)

############################## ANALYSE PARIS #########################################
data_acc_paris <- filter(data, dep == "75")
data_acc_paris <- select(data_acc_paris, -c(Unnamed..0, dep))
colnames(data_acc_paris)
view(data_acc_paris)

#####################" MERGE data_arr_paris & data_acc_paris avec lat et long comme clés unique ##########
merge_paris <- merge(data_arr_paris, data_acc_paris, by = c("lat", "long"))
view(merge_paris)

summary(merge_paris)


##################### Export vers fichier csv ##########################
ma_data_table <- as.data.table(merge_paris)
library(writexl)
write.csv(ma_data_table, "C:/Users/33662/Desktop/add_velo/data/data_paris.csv")




###################### DEBUT ANALYSE ################################

############################# Verif export ################################
library(readr)
data <- read.table("C:/Users/33662/Desktop/add_velo/data/data_paris.csv", sep=",", header = TRUE)
View(data)

summary(data$an)
table(data$Arrondissement)
sum(is.na(data$Arrondissement))



################################ Age ########################################

# Utiliser la fonction count() pour obtenir les fréquences
counts <- count(data, age)

# Renommer les colonnes
colnames(counts) <- c('age', 'Nombre')

ggplot(counts, aes(x = age, y = Nombre)) +
  geom_bar(stat = "identity", fill = "skyblue", color = "black") +
  labs(title = "Fréquences d'âge", x = "Âge", y = "Nombre") +
  theme_minimal()

summary(data$age)



############################# Genre ########################################

counts_genre <- count(data, Genre)

# Renommer les colonnes
colnames(counts_genre) <- c('genre', 'Nombre')

# Créer un graphique à barres avec ggplot2 pour les genres
ggplot(counts_genre, aes(x = genre, y = Nombre, fill = genre)) +
  geom_bar(stat = "identity", color = "black") +
  geom_text(aes(label = Nombre), position = position_stack(vjust = 1.2), size = 10) +  # Ajouter le nombre de valeurs au-dessus des barres
  labs(title = "Fréquences des genres", x = NULL, y = "Nombre") +  # Mettre x = NULL pour cacher les labels de l'axe x
  scale_fill_manual(values = c("Femme" = "pink", "Homme" = "skyblue")) +  # Attribuer la couleur rose à la catégorie "Femme"
  theme_minimal() +
  theme(axis.text.x = element_blank())


################## Analyses univariées #################################

data <- read.csv("C:/Users/33662/Desktop/add_velo/data/data_clean.csv", sep=",", header = TRUE)

data <- data %>%
  mutate(dep = as.numeric(dep))
data <- data %>%
  mutate(long = as.numeric(long))


plot1 <- ggplot(data, aes(x = an, fill = Consequence)) +
  geom_histogram(breaks = seq(min(data$an), max(data$an)), 
                 width = 2, color = "black", alpha = 0.7) +
  geom_density(alpha = 0.2) +
  labs(title = "Accidents par an") +
  ylab("Nb accidents") +
  theme_minimal() +
  scale_fill_manual(values = c("orange", "skyblue", "green", "red")) + 
  theme(legend.position = "none") 


# Créer un facteur ordonné avec les niveaux des mois
data$mois <- factor(data$mois, levels = c("janvier", "fevrier", "mars", "avril", "mai", "juin", "juillet", "aout", "septembre", "octobre", "novembre", "decembre"))
plot2 <- ggplot(data, aes(x = mois, fill = Consequence)) +
  geom_bar(color = "black") +
  labs(title = "Accidents par mois") +
  ylab("Nb accidents") +
  theme_minimal() +
  scale_x_discrete(breaks = c("janvier", "avril", "aout", "decembre")) +
  scale_fill_manual(values = c("orange", "skyblue", "green", "red")) +
  theme(legend.position = "none")


# Créer un facteur ordonné avec les niveaux des jours
data$jour <- factor(data$jour, levels = c("lundi", "mardi", "mercredi", "jeudi", "vendredi", "samedi", "dimanche"))
plot3 <- ggplot(data, aes(x = jour, fill = Consequence)) +
  geom_bar(color = "black") +
  labs(title = "Accidents par jour") +
  ylab("Nb accidents") +
  theme_minimal() +
  scale_x_discrete(breaks = c("lundi", "mercredi", "vendredi", "dimanche")) +
  scale_fill_manual(values = c("orange", "skyblue", "green", "red")) + 
  theme(legend.position = "none")  


# Créer un facteur ordonné avec les niveaux les heures
data$Tranche_horaire <- factor(data$Tranche_horaire, levels = c("Matin", "Apres-midi", "Soir", "Nuit", "NA"))
filtered_data <- data[!is.na(data$Tranche_horaire), ]
# Créer le graphique avec les données filtrées
plot4 <- ggplot(filtered_data, aes(x = Tranche_horaire, fill = Consequence)) +
  geom_bar(color = "black") +
  ylab("Nb accidents") +
  labs(title = "Accidents par tranche horaire") +
  theme_minimal() +
  scale_fill_manual(values = c("orange", "skyblue", "green", "red")) + 
  theme(legend.position = "bottom") 

arranged_plots <- arrangeGrob(plot1 + theme(legend.position = "none"),
                              plot2 + theme(legend.position = "none"),
                              plot3 + theme(legend.position = "none"),
                              plot4 + theme(legend.position = "none"),
                              ncol = 2)

# Ajouter une légende en bas
legend <- cowplot::get_legend(plot4)

# Afficher le graphique final avec la légende en bas
gridExtra::grid.arrange(arranged_plots, legend, ncol = 1,
                        heights = c(15, 1))


###############################################################"

ggplot(data, aes(x = Region, fill = Consequence)) +
  geom_bar(stat = "count", color = "black") +
  coord_flip() +  # Cela inverse les axes, rendant le graphique horizontal
  xlab("Régions") + 
  ylab("Nb accidents") +
  theme_minimal() +
  scale_fill_manual(values = c("orange", "skyblue", "green", "red")) + 
  theme(legend.position = "bottom")

############################### Analyse bivariée ##########################################

################# A REVOIR AVEC LE FICHIER ARRON PARIS ######


# Relation entre l'arrondissement et le type de collision
ggplot(data, aes(x = Arrondissement, fill = Collision)) +
  geom_bar(position = "stack", color = "black") +
  labs(title = "Relation entre l'arrondissement et le type de collision") +
  theme_minimal()

# Relation entre l'arrondissement et les conséquences 
ggplot(data, aes(x = Arrondissement, fill = Consequence.y)) +
  geom_bar(position = "stack", color = "black") +
  labs(title = "Relation entre l'arrondissement et les conséquences ") +
  theme_minimal()

# Relation entre les années et les accidents
ggplot(data, aes(x = an, fill = Consequence)) +
  geom_bar(position = "stack", color = "black") +
  labs(title = "Relation entre blabla") +
  theme_minimal()


colnames(data)

Factoshiny(data)











############################# ANALYSE PISTE CYCLABLE PARIS #########################
data_piste_paris <- read.table("C:/Users/33662/Desktop/add_velo/data/data_cycle-piste.csv", sep=",", header = TRUE)
df <- data_piste_paris


# Créer un graphique à barres empilées pour l'évolution des arrondissements par année
df <- df %>%
  filter(Arrondissement != "NA")
ggplot(df, aes(x = an, fill = factor(Arrondissement))) +
  geom_bar(position = "stack", color = "black") +
  labs(title = "Évolution des pistes cyclables dans les arrondissements au fil des années") +
  theme_minimal() +
  ylab("Nb aménagement")+
  theme(legend.position = "bottom") +
  guides(fill = guide_legend(title = "Arrondissements"))


# Change les valeurs dans la colonne "Typologie"
df <- df %>%
  mutate(Typologie = ifelse(Typologie == "Autres itineraires cyclables (ex : Aires pietonnes - Contre-sens cyclables)", "Aires pietonnes", Typologie))

# Affiche le data frame après le changement
# Relation entre l'arrondissement et les typo des pistes 
ggplot(df, aes(x = an, fill = factor(Arrondissement))) +
  geom_bar(position = "stack", color = "black") +
  facet_wrap(~Typologie, scales = "free_y") +
  labs(title = "Évolution des typologies des pistes par arrondissement au fil des années") +
  theme_minimal()+
  ylab("Nb aménagement")+
  theme(legend.position = "bottom") +
  guides(fill = guide_legend(title = "Arrondissements")) +
  # Ajustez la taille de la légende en modifiant les paramètres du thème
  theme(legend.key.size = unit(0.3, "cm"), # Ajuste la taille de la clé de la légende
        legend.title = element_text(size = 6), # Ajuste la taille du titre de la légende
        legend.text = element_text(size = 5)) # Ajuste la taille du texte de la légende





######################## PARIS #########################"
don <- read.table("C:/Users/33662/Desktop/add_velo/data/data_paris.csv", sep=",", header = TRUE)

ggplot(don, aes(x = Arrondissement, fill = Consequence.x)) +
  geom_bar(stat = "count", color = "black") +
  coord_flip() +  # Cela inverse les axes, rendant le graphique horizontal
  xlab("Arrondissement") + 
  ylab("Nb accidents") +
  theme_minimal() +
  scale_fill_manual(values = c("orange", "skyblue", "green", "red")) + 
  theme(legend.position = "bottom")+
  guides(fill = guide_legend(title = "Conséquence"))


























class(data$dep)
data$dep <- as.factor(data$dep)
data$dep <- as.numeric(data$dep)

class(data$dep)

# Sélectionner les colonnes quantitatives
data_quantitative <- data[, c("an", "age", "dep")]

# Sélectionner les colonnes qualitatives
data_qualitative <- data[, -c(1, 21, 25)]

# Vérifier la structure des données
str(data_qualitative)

# Effectuer une ACP sur les données quantitatives
acp <- PCA(data_quantitative, graph = FALSE)

# Visualiser les résultats de l'ACP
fviz_pca_ind(acp, col.ind = "cos2", palette = "jco", addEllipses = FALSE)

# Analyser les résultats de l'ACP
summary(acp)

# Effectuer une ACP sur les données qualitatives
acp_qualitative <- MCA(data_qualitative, graph = FALSE)

# Visualiser les résultats de l'ACP qualitative
fviz_mca_ind(acp_qualitative, col.ind = "cos2", palette = "jco", addEllipses = TRUE)

# Analyser les résultats de l'ACP qualitative
summary(acp_qualitative)



################################## ACP #############################
baseacp = as.data.frame(cbind(data$age,data$dep,data$an))
baseacp
res.pca <- PCA(baseacp,quali.sup = 1:1)







############################## AFC ###############################
baseAFC = as.data.frame(cbind(data$Consequence,data$Contexte))
baseAFC
# tableau de contingence
contingence = table(baseAFC)
contingence
# profils lignes et colonnes
ligne = prop.table(contingence, margin = 1)
ligne
colonne = prop.table(contingence, margin = 2)
colonne
# masses pour les lignes et les colonnes
nb_ind = sum(contingence)
masse_ligne = rowSums(contingence)/nb_ind
masse_col = colSums(contingence)/nb_ind
# Affichage graphe AFC
resultats_afc <- CA(contingence)
resultats_afc
# Effectuer le test du Chi carré
chi_squared_test <- chisq.test(contingence)
chi_squared_test
# Visualiser les contributions des variables aux axes
fviz_contrib(resultats_afc, choice = "row")
# Visualiser les cosinus carrés des variables aux axes
fviz_cos2(resultats_afc, choice = "col")



############################## AFC ###############################
baseAFC = as.data.frame(cbind(data$Consequence,data$Meteo))
baseAFC
# tableau de contingence
contingence = table(baseAFC)
contingence
# profils lignes et colonnes
ligne = prop.table(contingence, margin = 1)
ligne
colonne = prop.table(contingence, margin = 2)
colonne
# masses pour les lignes et les colonnes
nb_ind = sum(contingence)
masse_ligne = rowSums(contingence)/nb_ind
masse_col = colSums(contingence)/nb_ind
# Affichage graphe AFC
resultats_afc <- CA(contingence)
resultats_afc
# Effectuer le test du Chi carré
chi_squared_test <- chisq.test(contingence)
chi_squared_test
# Visualiser les contributions des variables aux axes
fviz_contrib(resultats_afc, choice = "row")
# Visualiser les cosinus carrés des variables aux axes
fviz_cos2(resultats_afc, choice = "col")


############################## AFC ###############################
baseAFC = as.data.frame(cbind(data$Consequence,data$Route))
baseAFC
# tableau de contingence
contingence = table(baseAFC)
contingence
# profils lignes et colonnes
ligne = prop.table(contingence, margin = 1)
ligne
colonne = prop.table(contingence, margin = 2)
colonne
# masses pour les lignes et les colonnes
nb_ind = sum(contingence)
masse_ligne = rowSums(contingence)/nb_ind
masse_col = colSums(contingence)/nb_ind
# Affichage graphe AFC
resultats_afc <- CA(contingence)
resultats_afc
# Effectuer le test du Chi carré
chi_squared_test <- chisq.test(contingence)
chi_squared_test
# Visualiser les contributions des variables aux axes
fviz_contrib(resultats_afc, choice = "row")
# Visualiser les cosinus carrés des variables aux axes
fviz_cos2(resultats_afc, choice = "col")


############################## AFC ###############################
baseAFC = as.data.frame(cbind(data$Consequence,data$Agglomeration))
baseAFC
# tableau de contingence
contingence = table(baseAFC)
contingence
# profils lignes et colonnes
ligne = prop.table(contingence, margin = 1)
ligne
colonne = prop.table(contingence, margin = 2)
colonne
# masses pour les lignes et les colonnes
nb_ind = sum(contingence)
masse_ligne = rowSums(contingence)/nb_ind
masse_col = colSums(contingence)/nb_ind
# Affichage graphe AFC
resultats_afc <- CA(contingence)
resultats_afc
# Effectuer le test du Chi carré
chi_squared_test <- chisq.test(contingence)
chi_squared_test
# Visualiser les contributions des variables aux axes
fviz_contrib(resultats_afc, choice = "row")
# Visualiser les cosinus carrés des variables aux axes
fviz_cos2(resultats_afc, choice = "col")


############################## AFC ###############################
baseAFC = as.data.frame(cbind(data$Consequence,data$Luminosite))
baseAFC
# tableau de contingence
contingence = table(baseAFC)
contingence
# profils lignes et colonnes
ligne = prop.table(contingence, margin = 1)
ligne
colonne = prop.table(contingence, margin = 2)
colonne
# masses pour les lignes et les colonnes
nb_ind = sum(contingence)
masse_ligne = rowSums(contingence)/nb_ind
masse_col = colSums(contingence)/nb_ind
# Affichage graphe AFC
resultats_afc <- CA(contingence)
resultats_afc
# Effectuer le test du Chi carré
chi_squared_test <- chisq.test(contingence)
chi_squared_test
# Visualiser les contributions des variables aux axes
fviz_contrib(resultats_afc, choice = "row")
# Visualiser les cosinus carrés des variables aux axes
fviz_cos2(resultats_afc, choice = "col")


############################## AFC ###############################
baseAFC = as.data.frame(cbind(data$Consequence,data$Equipement.secu))
baseAFC
# tableau de contingence
contingence = table(baseAFC)
contingence
# profils lignes et colonnes
ligne = prop.table(contingence, margin = 1)
ligne
colonne = prop.table(contingence, margin = 2)
colonne
# masses pour les lignes et les colonnes
nb_ind = sum(contingence)
masse_ligne = rowSums(contingence)/nb_ind
masse_col = colSums(contingence)/nb_ind
# Affichage graphe AFC
resultats_afc <- CA(contingence)
resultats_afc
# Effectuer le test du Chi carré
chi_squared_test <- chisq.test(contingence)
chi_squared_test
# Visualiser les contributions des variables aux axes
fviz_contrib(resultats_afc, choice = "row")
# Visualiser les cosinus carrés des variables aux axes
fviz_cos2(resultats_afc, choice = "col")




# Chargement du package
library(ca)

# Sélection des variables qualitatives
data_qualitative <- data[, c("mois", "Tranche_horaire", "Agglomeration", "intersection", "Collision", "Luminosite", "Meteo", "Route", "Circulation", "Profil.route", "Plan.route", "Surface", "Lieu", "Situation", "Consequence", "Genre", "Contexte", "Securite.equip", "Equipement.secu", "Obstacle.mobile", "Choc.subi")]

# Suppression des éventuelles lignes avec des données manquantes
data_qualitative <- na.omit(data_qualitative)

# Analyse Factorielle des Correspondances
afc_result <- CA(data_qualitative, graph = FALSE)

# Affichage des résultats
summary(afc_result)


# On enlève les valeurs NA 
baseAFC=na.omit(baseAFC)

# tableau de contingence
contingence = table(baseAFC)
contingence

# profils lignes et colonnes
ligne = prop.table(contingence, margin = 1)
ligne
colonne = prop.table(contingence, margin = 2)
colonne

# masses pour les lignes et les colonnes
nb_ind = sum(contingence)
masse_ligne = rowSums(contingence)/nb_ind
masse_col = colSums(contingence)/nb_ind


# Affichage graphe AFC
resultats_afc <- CA(contingence)


# Effectuer le test du Chi carré
chi_squared_test <- chisq.test(contingence)
chi_squared_test


# Visualiser les contributions des variables aux axes
fviz_contrib(resultats_afc, choice = "row")

# Visualiser les cosinus carrés des variables aux axes
fviz_cos2(resultats_afc, choice = "col")


# profils lignes et colonnes
ligne = prop.table(contingence, margin = 1)
ligne
colonne = prop.table(contingence, margin = 2)
colonne

barplot(ligne, beside = TRUE,
        space = c(0,1))

resultats_afc$row
resultats_afc$col
